<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>NewsPalette Admin - 관리자 대시보드</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<style>
:root {
    --primary: #3B82F6;
    --primary-hover: #2563EB;
    --bg-light: #F3F4F6;
    --bg-dark: #111827;
    --surface-light: #FFFFFF;
    --surface-dark: #1F2937;
    --text-main-light: #111827;
    --text-main-dark: #F9FAFB;
    --text-sub-light: #6B7280;
    --text-sub-dark: #9CA3AF;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-300: #d1d5db;
    --gray-400: #9ca3af;
    --gray-500: #6b7280;
    --gray-600: #4b5563;
    --gray-700: #374151;
    --gray-800: #1f2937;
    --gray-900: #111827;
    --success: #10B981;
    --success-bg: #D1FAE5;
    --warning: #F59E0B;
    --warning-bg: #FEF3C7;
    --error: #EF4444;
    --error-bg: #FEE2E2;
    --info: #3B82F6;
    --info-bg: #DBEAFE;
    --sidebar-width: 260px;
    --header-height: 64px;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Noto Sans KR', sans-serif;
    background-color: var(--bg-light);
    color: var(--text-main-light);
    min-height: 100vh;
    transition: background-color 0.2s, color 0.2s;
}

body.dark {
    background-color: var(--bg-dark);
    color: var(--text-main-dark);
}

/* Layout */
.admin-layout {
    display: flex;
    min-height: 100vh;
}

/* Sidebar */
.sidebar {
    position: fixed;
    left: 0;
    top: 0;
    width: var(--sidebar-width);
    height: 100vh;
    background: var(--surface-light);
    border-right: 1px solid var(--gray-200);
    display: flex;
    flex-direction: column;
    z-index: 100;
    transition: transform 0.3s ease, background-color 0.2s, border-color 0.2s;
}

body.dark .sidebar {
    background: var(--surface-dark);
    border-right-color: var(--gray-700);
}

.sidebar-header {
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--gray-200);
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

body.dark .sidebar-header {
    border-bottom-color: var(--gray-700);
}

.sidebar-logo {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
}

.sidebar-logo-icon {
    color: var(--primary);
    font-size: 1.75rem;
}

.sidebar-logo-text {
    font-weight: 700;
    font-size: 1.125rem;
    color: var(--primary);
}

.sidebar-badge {
    background: linear-gradient(135deg, var(--primary), #8B5CF6);
    color: white;
    font-size: 0.625rem;
    font-weight: 700;
    padding: 0.125rem 0.375rem;
    border-radius: 4px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.sidebar-nav {
    flex: 1;
    padding: 1rem 0;
    overflow-y: auto;
}

.nav-section {
    margin-bottom: 1.5rem;
}

.nav-section-title {
    padding: 0.5rem 1.5rem;
    font-size: 0.6875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--gray-400);
}

body.dark .nav-section-title {
    color: var(--gray-500);
}

.nav-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1.5rem;
    color: var(--gray-600);
    text-decoration: none;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.15s ease;
    cursor: pointer;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
}

body.dark .nav-item {
    color: var(--gray-400);
}

.nav-item:hover {
    background: var(--gray-100);
    color: var(--gray-900);
}

body.dark .nav-item:hover {
    background: var(--gray-800);
    color: var(--gray-100);
}

.nav-item.active {
    background: rgba(59, 130, 246, 0.1);
    color: var(--primary);
    border-right: 3px solid var(--primary);
}

body.dark .nav-item.active {
    background: rgba(59, 130, 246, 0.15);
}

.nav-item .material-symbols-outlined {
    font-size: 1.25rem;
}

.nav-item-badge {
    margin-left: auto;
    background: var(--error);
    color: white;
    font-size: 0.6875rem;
    font-weight: 700;
    padding: 0.125rem 0.5rem;
    border-radius: 999px;
    min-width: 1.25rem;
    text-align: center;
}

.sidebar-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--gray-200);
}

body.dark .sidebar-footer {
    border-top-color: var(--gray-700);
}

.sidebar-user {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.sidebar-avatar {
    width: 2.25rem;
    height: 2.25rem;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary), #8B5CF6);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 0.875rem;
}

.sidebar-user-info {
    flex: 1;
    min-width: 0;
}

.sidebar-user-name {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--gray-900);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

body.dark .sidebar-user-name {
    color: var(--gray-100);
}

.sidebar-user-role {
    font-size: 0.75rem;
    color: var(--gray-500);
}

/* Main Content */
.main-content {
    flex: 1;
    margin-left: var(--sidebar-width);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

/* Header */
.admin-header {
    position: sticky;
    top: 0;
    z-index: 50;
    height: var(--header-height);
    background: var(--surface-light);
    border-bottom: 1px solid var(--gray-200);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 1.5rem;
}

body.dark .admin-header {
    background: var(--surface-dark);
    border-bottom-color: var(--gray-700);
}

.header-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--gray-900);
}

body.dark .header-title {
    color: var(--gray-100);
}

.header-actions {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.icon-btn {
    width: 2.25rem;
    height: 2.25rem;
    border-radius: 0.5rem;
    border: none;
    background: transparent;
    color: var(--gray-500);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s ease;
}

.icon-btn:hover {
    background: var(--gray-100);
    color: var(--gray-700);
}

body.dark .icon-btn:hover {
    background: var(--gray-800);
    color: var(--gray-300);
}

/* Page Content */
.page-content {
    flex: 1;
    padding: 1.5rem;
}

.page-section {
    display: none;
}

.page-section.active {
    display: block;
}

/* Cards */
.card {
    background: var(--surface-light);
    border: 1px solid var(--gray-200);
    border-radius: 0.75rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    overflow: hidden;
}

body.dark .card {
    background: var(--surface-dark);
    border-color: var(--gray-700);
}

.card-header {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--gray-200);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    flex-wrap: wrap;
}

body.dark .card-header {
    border-bottom-color: var(--gray-700);
}

.card-title {
    font-size: 1rem;
    font-weight: 700;
    color: var(--gray-900);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

body.dark .card-title {
    color: var(--gray-100);
}

.card-body {
    padding: 1.25rem;
}

/* Stats Grid */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.stat-card {
    background: var(--surface-light);
    border: 1px solid var(--gray-200);
    border-radius: 0.75rem;
    padding: 1.25rem;
    display: flex;
    align-items: flex-start;
    gap: 1rem;
}

body.dark .stat-card {
    background: var(--surface-dark);
    border-color: var(--gray-700);
}

.stat-icon {
    width: 3rem;
    height: 3rem;
    border-radius: 0.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.stat-icon.blue { background: var(--info-bg); color: var(--info); }
.stat-icon.green { background: var(--success-bg); color: var(--success); }
.stat-icon.yellow { background: var(--warning-bg); color: var(--warning); }
.stat-icon.red { background: var(--error-bg); color: var(--error); }

body.dark .stat-icon.blue { background: rgba(59, 130, 246, 0.2); }
body.dark .stat-icon.green { background: rgba(16, 185, 129, 0.2); }
body.dark .stat-icon.yellow { background: rgba(245, 158, 11, 0.2); }
body.dark .stat-icon.red { background: rgba(239, 68, 68, 0.2); }

.stat-info {
    flex: 1;
}

.stat-label {
    font-size: 0.8125rem;
    color: var(--gray-500);
    margin-bottom: 0.25rem;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--gray-900);
}

body.dark .stat-value {
    color: var(--gray-100);
}

.stat-change {
    font-size: 0.75rem;
    margin-top: 0.25rem;
}

.stat-change.up { color: var(--success); }
.stat-change.down { color: var(--error); }

/* Filter Bar */
.filter-bar {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-wrap: wrap;
}

.filter-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.filter-label {
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--gray-600);
}

body.dark .filter-label {
    color: var(--gray-400);
}

.filter-select {
    padding: 0.5rem 2rem 0.5rem 0.75rem;
    border: 1px solid var(--gray-300);
    border-radius: 0.5rem;
    font-size: 0.8125rem;
    background: var(--surface-light);
    color: var(--gray-700);
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236B7280' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.5rem center;
}

body.dark .filter-select {
    background-color: var(--gray-800);
    border-color: var(--gray-600);
    color: var(--gray-300);
}

.filter-input {
    padding: 0.5rem 0.75rem;
    border: 1px solid var(--gray-300);
    border-radius: 0.5rem;
    font-size: 0.8125rem;
    background: var(--surface-light);
    color: var(--gray-700);
    min-width: 200px;
}

body.dark .filter-input {
    background-color: var(--gray-800);
    border-color: var(--gray-600);
    color: var(--gray-300);
}

.filter-input::placeholder {
    color: var(--gray-400);
}

.btn {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    font-size: 0.8125rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s ease;
    border: none;
}

.btn-primary {
    background: var(--primary);
    color: white;
}

.btn-primary:hover {
    background: var(--primary-hover);
}

.btn-secondary {
    background: var(--gray-100);
    color: var(--gray-700);
    border: 1px solid var(--gray-300);
}

body.dark .btn-secondary {
    background: var(--gray-800);
    color: var(--gray-300);
    border-color: var(--gray-600);
}

.btn-secondary:hover {
    background: var(--gray-200);
}

body.dark .btn-secondary:hover {
    background: var(--gray-700);
}

.btn-danger {
    background: var(--error);
    color: white;
}

.btn-danger:hover {
    background: #DC2626;
}

.btn-sm {
    padding: 0.375rem 0.625rem;
    font-size: 0.75rem;
}

.btn .material-symbols-outlined {
    font-size: 1rem;
}

/* Tables */
.table-container {
    overflow-x: auto;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.875rem;
}

.data-table th,
.data-table td {
    padding: 0.875rem 1rem;
    text-align: left;
    border-bottom: 1px solid var(--gray-200);
}

body.dark .data-table th,
body.dark .data-table td {
    border-bottom-color: var(--gray-700);
}

.data-table th {
    font-weight: 600;
    color: var(--gray-500);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    background: var(--gray-50);
}

body.dark .data-table th {
    background: rgba(55, 65, 81, 0.3);
    color: var(--gray-400);
}

.data-table tr:hover td {
    background: var(--gray-50);
}

body.dark .data-table tr:hover td {
    background: rgba(55, 65, 81, 0.3);
}

.data-table td {
    color: var(--gray-700);
}

body.dark .data-table td {
    color: var(--gray-300);
}

/* Log Badges */
.log-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.625rem;
    border-radius: 999px;
    font-size: 0.6875rem;
    font-weight: 600;
    text-transform: uppercase;
}

.log-badge.error {
    background: var(--error-bg);
    color: #991B1B;
}

.log-badge.warning {
    background: var(--warning-bg);
    color: #92400E;
}

.log-badge.info {
    background: var(--info-bg);
    color: #1E40AF;
}

.log-badge.success {
    background: var(--success-bg);
    color: #065F46;
}

body.dark .log-badge.error { background: rgba(239,68,68,0.2); color: #FCA5A5; }
body.dark .log-badge.warning { background: rgba(245,158,11,0.2); color: #FCD34D; }
body.dark .log-badge.info { background: rgba(59,130,246,0.2); color: #93C5FD; }
body.dark .log-badge.success { background: rgba(16,185,129,0.2); color: #6EE7B7; }

/* Status Badge */
.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.25rem 0.625rem;
    border-radius: 999px;
    font-size: 0.75rem;
    font-weight: 600;
}

.status-badge::before {
    content: "";
    width: 6px;
    height: 6px;
    border-radius: 50%;
}

.status-badge.active { background: var(--success-bg); color: #065F46; }
.status-badge.active::before { background: var(--success); }

.status-badge.inactive { background: var(--gray-100); color: var(--gray-600); }
.status-badge.inactive::before { background: var(--gray-400); }

.status-badge.suspended { background: var(--error-bg); color: #991B1B; }
.status-badge.suspended::before { background: var(--error); }

body.dark .status-badge.active { background: rgba(16,185,129,0.2); color: #6EE7B7; }
body.dark .status-badge.inactive { background: rgba(107,114,128,0.2); color: var(--gray-400); }
body.dark .status-badge.suspended { background: rgba(239,68,68,0.2); color: #FCA5A5; }

/* Label Chips */
.label-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
}

.label-chip {
    padding: 0.125rem 0.5rem;
    border-radius: 4px;
    font-size: 0.6875rem;
    font-weight: 600;
}

.label-chip.society { background: #DBEAFE; color: #1E40AF; }
.label-chip.politics { background: #FEE2E2; color: #991B1B; }
.label-chip.world { background: #D1FAE5; color: #065F46; }
.label-chip.culture { background: #EDE9FE; color: #5B21B6; }
.label-chip.sports { background: #DCFCE7; color: #166534; }
.label-chip.economy { background: #FEF3C7; color: #92400E; }
.label-chip.local { background: #FEF3C7; color: #92400E; }

body.dark .label-chip.society { background: rgba(59,130,246,0.2); color: #93C5FD; }
body.dark .label-chip.politics { background: rgba(239,68,68,0.2); color: #FCA5A5; }
body.dark .label-chip.world { background: rgba(16,185,129,0.2); color: #6EE7B7; }
body.dark .label-chip.culture { background: rgba(139,92,246,0.2); color: #C4B5FD; }
body.dark .label-chip.sports { background: rgba(34,197,94,0.2); color: #86EFAC; }
body.dark .label-chip.economy { background: rgba(245,158,11,0.2); color: #FCD34D; }

/* Actions */
.action-btns {
    display: flex;
    gap: 0.375rem;
}

.action-btn {
    width: 2rem;
    height: 2rem;
    border-radius: 0.375rem;
    border: none;
    background: transparent;
    color: var(--gray-500);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s ease;
}

.action-btn:hover {
    background: var(--gray-100);
    color: var(--gray-700);
}

body.dark .action-btn:hover {
    background: var(--gray-700);
    color: var(--gray-300);
}

.action-btn.delete:hover {
    background: var(--error-bg);
    color: var(--error);
}

.action-btn .material-symbols-outlined {
    font-size: 1.125rem;
}

/* User Avatar in Table */
.user-cell {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.user-avatar {
    width: 2.25rem;
    height: 2.25rem;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary), #8B5CF6);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 0.8125rem;
    flex-shrink: 0;
}

.user-details {
    min-width: 0;
}

.user-name {
    font-weight: 600;
    color: var(--gray-900);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

body.dark .user-name {
    color: var(--gray-100);
}

.user-email {
    font-size: 0.75rem;
    color: var(--gray-500);
}

/* Log Message */
.log-message {
    font-family: 'SF Mono', Monaco, 'Consolas', monospace;
    font-size: 0.8125rem;
    color: var(--gray-700);
    max-width: 400px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

body.dark .log-message {
    color: var(--gray-300);
}

/* Article Title in Table */
.article-title-cell {
    max-width: 300px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-weight: 500;
}

/* Pagination */
.table-footer {
    padding: 1rem 1.25rem;
    border-top: 1px solid var(--gray-200);
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 1rem;
}

body.dark .table-footer {
    border-top-color: var(--gray-700);
}

.table-info {
    font-size: 0.8125rem;
    color: var(--gray-500);
}

.pagination {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.page-btn {
    width: 2rem;
    height: 2rem;
    border-radius: 0.375rem;
    border: none;
    background: transparent;
    color: var(--gray-600);
    font-size: 0.8125rem;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s ease;
}

.page-btn:hover {
    background: var(--gray-100);
}

body.dark .page-btn {
    color: var(--gray-400);
}

body.dark .page-btn:hover {
    background: var(--gray-800);
}

.page-btn.active {
    background: var(--primary);
    color: white;
}

.page-btn.active:hover {
    background: var(--primary-hover);
}

/* Modal */
.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 1rem;
}

.modal-overlay.active {
    display: flex;
}

.modal {
    background: var(--surface-light);
    border-radius: 1rem;
    width: 100%;
    max-width: 32rem;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
}

body.dark .modal {
    background: var(--surface-dark);
}

.modal-header {
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--gray-200);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

body.dark .modal-header {
    border-bottom-color: var(--gray-700);
}

.modal-title {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--gray-900);
}

body.dark .modal-title {
    color: var(--gray-100);
}

.modal-close {
    width: 2rem;
    height: 2rem;
    border-radius: 0.5rem;
    border: none;
    background: transparent;
    color: var(--gray-500);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-close:hover {
    background: var(--gray-100);
}

body.dark .modal-close:hover {
    background: var(--gray-800);
}

.modal-body {
    padding: 1.5rem;
    overflow-y: auto;
}

.modal-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--gray-200);
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
}

body.dark .modal-footer {
    border-top-color: var(--gray-700);
}

/* Form */
.form-group {
    margin-bottom: 1.25rem;
}

.form-group:last-child {
    margin-bottom: 0;
}

.form-label {
    display: block;
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--gray-700);
    margin-bottom: 0.5rem;
}

body.dark .form-label {
    color: var(--gray-300);
}

.form-input,
.form-select,
.form-textarea {
    width: 100%;
    padding: 0.625rem 0.875rem;
    border: 1px solid var(--gray-300);
    border-radius: 0.5rem;
    font-size: 0.875rem;
    background: var(--surface-light);
    color: var(--gray-900);
    transition: border-color 0.15s, box-shadow 0.15s;
}

body.dark .form-input,
body.dark .form-select,
body.dark .form-textarea {
    background: var(--gray-800);
    border-color: var(--gray-600);
    color: var(--gray-100);
}

.form-input:focus,
.form-select:focus,
.form-textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(59,130,246,0.15);
}

.form-textarea {
    min-height: 100px;
    resize: vertical;
}

.form-checkbox-group {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
}

.form-checkbox-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
}

.form-checkbox-item input[type="checkbox"] {
    width: 1rem;
    height: 1rem;
    accent-color: var(--primary);
}

.form-checkbox-label {
    font-size: 0.875rem;
    color: var(--gray-700);
}

body.dark .form-checkbox-label {
    color: var(--gray-300);
}

/* Activity Timeline */
.activity-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.activity-item {
    display: flex;
    gap: 1rem;
    padding: 1rem;
    border-radius: 0.5rem;
    background: var(--gray-50);
}

body.dark .activity-item {
    background: rgba(55,65,81,0.3);
}

.activity-icon {
    width: 2.25rem;
    height: 2.25rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.activity-icon.login { background: var(--info-bg); color: var(--info); }
.activity-icon.view { background: var(--success-bg); color: var(--success); }
.activity-icon.action { background: var(--warning-bg); color: var(--warning); }

body.dark .activity-icon.login { background: rgba(59,130,246,0.2); }
body.dark .activity-icon.view { background: rgba(16,185,129,0.2); }
body.dark .activity-icon.action { background: rgba(245,158,11,0.2); }

.activity-content {
    flex: 1;
}

.activity-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--gray-900);
    margin-bottom: 0.25rem;
}

body.dark .activity-title {
    color: var(--gray-100);
}

.activity-desc {
    font-size: 0.8125rem;
    color: var(--gray-600);
}

body.dark .activity-desc {
    color: var(--gray-400);
}

.activity-time {
    font-size: 0.75rem;
    color: var(--gray-400);
    white-space: nowrap;
}

/* Responsive - Keep sidebar always visible */
@media (max-width: 1024px) {
    :root {
        --sidebar-width: 200px;
    }
    
    .sidebar {
        width: var(--sidebar-width);
    }
    
    .main-content {
        margin-left: var(--sidebar-width);
    }
}

@media (max-width: 768px) {
    :root {
        --sidebar-width: 180px;
    }
    
    .nav-item {
        padding: 0.625rem 1rem;
        font-size: 0.8125rem;
    }
    
    .sidebar-header {
        padding: 1rem;
    }
    
    .sidebar-logo-text {
        font-size: 1rem;
    }
    
    .sidebar-badge {
        font-size: 0.5625rem;
        padding: 0.125rem 0.25rem;
    }
}

.menu-toggle {
    display: none;
}

/* Toast Notification */
.toast-container {
    position: fixed;
    bottom: 1.5rem;
    right: 1.5rem;
    z-index: 2000;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.toast {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem 1.25rem;
    border-radius: 0.75rem;
    background: var(--surface-light);
    border: 1px solid var(--gray-200);
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    animation: slideIn 0.3s ease;
}

body.dark .toast {
    background: var(--surface-dark);
    border-color: var(--gray-700);
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.toast-icon {
    width: 1.5rem;
    height: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
}

.toast.success .toast-icon { color: var(--success); }
.toast.error .toast-icon { color: var(--error); }
.toast.warning .toast-icon { color: var(--warning); }
.toast.info .toast-icon { color: var(--info); }

.toast-message {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--gray-700);
}

body.dark .toast-message {
    color: var(--gray-300);
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 3rem 1.5rem;
}

.empty-icon {
    font-size: 3rem;
    color: var(--gray-300);
    margin-bottom: 1rem;
}

body.dark .empty-icon {
    color: var(--gray-600);
}

.empty-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--gray-700);
    margin-bottom: 0.5rem;
}

body.dark .empty-title {
    color: var(--gray-300);
}

.empty-desc {
    font-size: 0.875rem;
    color: var(--gray-500);
}

/* Settings Page */
.settings-section {
    margin-bottom: 2rem;
}

.settings-section:last-child {
    margin-bottom: 0;
}

.settings-section-title {
    font-size: 1rem;
    font-weight: 700;
    color: var(--gray-900);
    margin-bottom: 0.25rem;
}

body.dark .settings-section-title {
    color: var(--gray-100);
}

.settings-section-desc {
    font-size: 0.8125rem;
    color: var(--gray-500);
    margin-bottom: 1.25rem;
}

.settings-list {
    display: flex;
    flex-direction: column;
    gap: 0;
}

.settings-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 0;
    border-bottom: 1px solid var(--gray-200);
}

body.dark .settings-item {
    border-bottom-color: var(--gray-700);
}

.settings-item:last-child {
    border-bottom: none;
}

.settings-item-info {
    flex: 1;
    min-width: 0;
    padding-right: 1rem;
}

.settings-item-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--gray-900);
    margin-bottom: 0.25rem;
}

body.dark .settings-item-title {
    color: var(--gray-100);
}

.settings-item-desc {
    font-size: 0.8125rem;
    color: var(--gray-500);
}

/* Switch Toggle */
.switch {
    position: relative;
    display: inline-block;
    width: 44px;
    height: 24px;
    flex-shrink: 0;
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--gray-300);
    transition: 0.3s;
    border-radius: 24px;
}

body.dark .slider {
    background-color: var(--gray-600);
}

.slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: 0.3s;
    border-radius: 50%;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

.switch input:checked + .slider {
    background-color: var(--primary);
}

.switch input:checked + .slider:before {
    transform: translateX(20px);
}

/* Topic Article Labels */
.topic-stats {
    display: flex;
    gap: 0.5rem;
}

.topic-stat {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.6875rem;
    font-weight: 600;
}

.topic-stat.positive {
    background: var(--success-bg);
    color: #065F46;
}

.topic-stat.negative {
    background: var(--error-bg);
    color: #991B1B;
}

.topic-stat.neutral {
    background: var(--info-bg);
    color: #1E40AF;
}

body.dark .topic-stat.positive {
    background: rgba(16, 185, 129, 0.2);
    color: #6EE7B7;
}

body.dark .topic-stat.negative {
    background: rgba(239, 68, 68, 0.2);
    color: #FCA5A5;
}

body.dark .topic-stat.neutral {
    background: rgba(59, 130, 246, 0.2);
    color: #93C5FD;
}

/* Topic Articles List in Modal */
.topic-articles-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    max-height: 300px;
    overflow-y: auto;
}

.topic-article-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    border-radius: 0.5rem;
    background: var(--gray-50);
    border: 1px solid var(--gray-200);
}

body.dark .topic-article-item {
    background: rgba(55, 65, 81, 0.3);
    border-color: var(--gray-700);
}

.topic-article-title {
    flex: 1;
    font-size: 0.875rem;
    color: var(--gray-700);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

body.dark .topic-article-title {
    color: var(--gray-300);
}

.topic-article-actions {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-shrink: 0;
}

.topic-article-actions select {
    padding: 0.375rem 0.625rem;
    border-radius: 0.375rem;
    font-size: 0.75rem;
    border: 1px solid var(--gray-300);
    background: var(--surface-light);
    color: var(--gray-700);
}

body.dark .topic-article-actions select {
    background: var(--gray-800);
    border-color: var(--gray-600);
    color: var(--gray-300);
}

.topic-article-delete-btn {
    width: 1.75rem;
    height: 1.75rem;
    border-radius: 0.375rem;
    border: none;
    background: transparent;
    color: var(--gray-400);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s ease;
}

.topic-article-delete-btn:hover {
    background: var(--error-bg);
    color: var(--error);
}

body.dark .topic-article-delete-btn:hover {
    background: rgba(239, 68, 68, 0.2);
}

.topic-article-delete-btn .material-symbols-outlined {
    font-size: 1rem;
}
/* 공통 ellipsis */
.col-id,
.col-title,
.col-date {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* 컬럼별 최대 폭 */
.col-id {
  max-width: 220px;
}

.col-title {
  max-width: 420px;
}

.col-date {
  max-width: 180px;
  font-variant-numeric: tabular-nums; /* 숫자 정렬 깔끔 */
}

/* 링크도 같이 잘리게 */
.col-id a,
.article-title-text {
  display: inline-block;
  max-width: 100%;
  white-space: inherit;
  overflow: inherit;
  text-overflow: inherit;
}
@media (max-width: 1024px) {
  .col-title { max-width: 300px; }
}

@media (max-width: 768px) {
  .col-id { max-width: 160px; }
  .col-title { max-width: 220px; }
  .col-date { max-width: 140px; }
}

/* ✅ 카테고리 컬럼은 줄바꿈/ellipsis 금지 + 최소폭 보장 */
.col-category{
  white-space: nowrap;
  overflow: visible;      /* ... 안 되게 */
  text-overflow: clip;
  min-width: 120px;       /* 카테고리 글자 길이에 맞춰 조절 */
}

/* label-chip이 찌그러지는 경우 방지 */
.col-category .label-chip{
  display: inline-flex;
  white-space: nowrap;
}
/* 기본값: 펼친 사이드바 */
.sidebar {
  transform: translateX(0);
  transition: transform 0.25s ease;
}

/* ✅ 접힌 상태: 화면 밖으로 밀기 (폭만큼) */
.sidebar.collapsed {
  transform: translateX(calc(-1 * var(--sidebar-width)));
}

/* ✅ 접힌 상태에서 왼쪽에 “잡는 영역(핫존)” 만들기 */
.sidebar-collapsed-hitbox {
  position: fixed;
  left: 0;
  top: 0;
  width: 12px;          /* 마우스 감지 영역 */
  height: 100vh;
  z-index: 120;         /* sidebar(100)보다 위 */
  display: none;
}

/* 접힌 상태일 때만 hitbox 활성화 */
body.sidebar-collapsed .sidebar-collapsed-hitbox {
  display: block;
}

/* ✅ 메인 컨텐츠도 같이 당기기 */
body.sidebar-collapsed .main-content {
  margin-left: 0;
}

.status-badge {
  white-space: nowrap;   /* ✅ '활성' 줄바꿈 금지 */
  flex-wrap: nowrap;     /* ✅ inline-flex라도 wrap 금지 */
}

/* 기사 본문 textarea */
#editArticleContent {
  width:100%;
  white-space: pre-wrap;
  overflow-wrap: anywhere;  /* 긴 토큰도 강제 줄바꿈 */
  word-break: break-word;
  overflow-x: hidden;  
  min-height: 160px;   /* 기존 120~140이면 → 160 */
  max-height: 300px;   /* 기존 220이면 → 300 */
}


</style>
</head>
<body>
<div class="admin-layout">
    <div class="sidebar-collapsed-hitbox" id="sidebarHitbox"></div>
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a class="sidebar-logo" href="home.html">
                <span class="material-symbols-outlined sidebar-logo-icon">palette</span>
                <span class="sidebar-logo-text">NewsPalette</span>
            </a>
        </div>
        
        <nav class="sidebar-nav">
            <!-- <div class="nav-section">
                <div class="nav-section-title">대시보드</div>
                <button class="nav-item active" data-page="dashboard">
                    <span class="material-symbols-outlined">dashboard</span>
                    <span>개요</span>
                </button>
            </div> -->
            
            <div class="nav-section">
                <div class="nav-section-title">모니터링</div>
                <button class="nav-item" data-page="logs">
                    <span class="material-symbols-outlined">terminal</span>
                    <span>시스템 로그</span>
                    <span class="nav-item-badge" id="errorCount">3</span>
                </button>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">관리</div>
                <button class="nav-item" data-page="users">
                    <span class="material-symbols-outlined">group</span>
                    <span>사용자 관리</span>
                </button>
                <button class="nav-item" data-page="articles">
                    <span class="material-symbols-outlined">article</span>
                    <span>기사 관리</span>
                </button>
                <button class="nav-item" data-page="topics">
                    <span class="material-symbols-outlined">category</span>
                    <span>토픽 관리</span>
                </button>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">설정</div>
                <button class="nav-item" data-page="settings">
                    <span class="material-symbols-outlined">settings</span>
                    <span>시스템 설정</span>
                </button>
            </div>
        </nav>
        
        <div class="sidebar-footer">
            <div class="sidebar-user">
                <div class="sidebar-avatar">관</div>
                <div class="sidebar-user-info">
                    <div class="sidebar-user-name">관리자</div>
                    <div class="sidebar-user-role">Super Admin</div>
                </div>
            </div>
        </div>
    </aside>
    
    <!-- Main Content -->
    <div class="main-content">
        <header class="admin-header">
            <button class="icon-btn menu-toggle" onclick="toggleSidebar()">
                <span class="material-symbols-outlined">menu</span>
            </button>
            <h1 class="header-title" id="pageTitle">대시보드 개요</h1>
            <div class="header-actions">
                <button class="icon-btn" onclick="toggleDarkMode()">
                    <span class="material-symbols-outlined">dark_mode</span>
                </button>
                <button class="icon-btn">
                    <span class="material-symbols-outlined">notifications</span>
                </button>
            </div>
        </header>
        
        <main class="page-content">
            <!-- Dashboard Page -->
            <!-- <section class="page-section active" id="page-dashboard">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon blue">
                            <span class="material-symbols-outlined">group</span>
                        </div>
                        <div class="stat-info">
                            <div class="stat-label">총 사용자</div>
                            <div class="stat-value">12,847</div>
                            <div class="stat-change up">↑ 12% 이번 달</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green">
                            <span class="material-symbols-outlined">article</span>
                        </div>
                        <div class="stat-info">
                            <div class="stat-label">총 기사</div>
                            <div class="stat-value">45,231</div>
                            <div class="stat-change up">↑ 8% 이번 달</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon yellow">
                            <span class="material-symbols-outlined">visibility</span>
                        </div>
                        <div class="stat-info">
                            <div class="stat-label">오늘 조회수</div>
                            <div class="stat-value">24,521</div>
                            <div class="stat-change up">↑ 5% 어제 대비</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon red">
                            <span class="material-symbols-outlined">error</span>
                        </div>
                        <div class="stat-info">
                            <div class="stat-label">오류 발생</div>
                            <div class="stat-value" id="error_stat_value">3</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <span class="material-symbols-outlined">history</span>
                            최근 활동
                        </h2>
                    </div>
                    <div class="card-body">
                        <div class="activity-list">
                            <div class="activity-item">
                                <div class="activity-icon login">
                                    <span class="material-symbols-outlined">login</span>
                                </div>
                                <div class="activity-content">
                                    <div class="activity-title">새 사용자 가입</div>
                                    <div class="activity-desc">user1234@email.com 님이 가입했습니다.</div>
                                </div>
                                <div class="activity-time">5분 전</div>
                            </div>
                            <div class="activity-item">
                                <div class="activity-icon action">
                                    <span class="material-symbols-outlined">edit</span>
                                </div>
                                <div class="activity-content">
                                    <div class="activity-title">기사 라벨 수정</div>
                                    <div class="activity-desc">"북한, 동해상으로 탄도미사일 발사" 기사 라벨이 수정되었습니다.</div>
                                </div>
                                <div class="activity-time">12분 전</div>
                            </div>
                            <div class="activity-item">
                                <div class="activity-icon view">
                                    <span class="material-symbols-outlined">trending_up</span>
                                </div>
                                <div class="activity-content">
                                    <div class="activity-title">트래픽 증가</div>
                                    <div class="activity-desc">사회/경제 카테고리 조회수가 평소 대비 150% 증가했습니다.</div>
                                </div>
                                <div class="activity-time">1시간 전</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section> -->
            
            <!-- Logs Page -->
            <section class="page-section active" id="page-logs">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <span class="material-symbols-outlined">terminal</span>
                            시스템 로그
                        </h2>
                        <div class="filter-bar">
                            <div class="filter-group">
                                <label class="filter-label">유형:</label>
                                <select class="filter-select" id="logTypeFilter" onchange="filterLogs()">
                                    <option value="all">전체</option>
                                    <option value="error">오류</option>
                                    <option value="warning">경고</option>
                                    <option value="info">정보</option>
                                    <option value="success">성공</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">기간:</label>
                                <select class="filter-select" id="logPeriodFilter" onchange="filterLogs()">
                                    <option value="today">오늘</option>
                                    <option value="week">이번 주</option>
                                    <option value="month">이번 달</option>
                                    <option value="all">전체</option>
                                </select>
                            </div>
                            <input type="text" class="filter-input" placeholder="로그 검색..." id="logSearchInput" oninput="filterLogs()">
                            <button class="btn btn-secondary" onclick="refreshLogs()">
                                <span class="material-symbols-outlined">refresh</span>
                                새로고침
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table" id="logsTable">
                            <thead>
                                <tr>
                                    <th>시간</th>
                                    <th>유형</th>
                                    <th>소스</th>
                                    <th>메시지</th>
                                    <th>상세보기</th>
                                </tr>
                            </thead>
                            <tbody id="logsTableBody">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                    <div class="table-footer">
                        <div class="table-info">총 <strong id="logsTotalCount">0</strong>개의 로그</div>
                        <div class="pagination" id="logsPagination">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Users Page -->
            <section class="page-section" id="page-users">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <span class="material-symbols-outlined">group</span>
                            사용자 관리
                        </h2>
                        <div class="filter-bar">
                            <div class="filter-group">
                                <label class="filter-label">상태:</label>
                                <select class="filter-select" id="userStatusFilter" onchange="filterUsers()">
                                    <option value="all">전체</option>
                                    <option value="active">활성</option>
                                    <option value="inactive">비활성</option>
                                    <option value="suspended">정지</option>
                                </select>
                            </div>
                            <input type="text" class="filter-input" placeholder="이름 또는 이메일 검색..." id="userSearchInput" oninput="filterUsers()">
                            <button class="btn btn-primary">
                                <span class="material-symbols-outlined">person_add</span>
                                사용자 추가
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table" id="usersTable">
                            <thead>
                                <tr>
                                    <th>사용자</th>
                                    <th>가입일</th>
                                    <th>마지막 활동</th>
                                    <th>상태</th>
                                    <th>작업</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                    <div class="table-footer">
                        <div class="table-info">총 <strong id="usersTotalCount">0</strong>명의 사용자</div>
                        <div class="pagination" id="usersPagination">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Articles Page -->
            <section class="page-section" id="page-articles">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <span class="material-symbols-outlined">article</span>
                            기사 관리
                        </h2>
                        <div class="filter-bar">
                            <div class="filter-group">
                                <label class="filter-label">카테고리:</label>
                                <select class="filter-select" id="articleCategoryFilter" onchange="filterArticles()">
                                    <option value="all">전체</option>
                                    <option value="society">사회/경제</option>
                                    <option value="politics">정치</option>
                                    <option value="world">국제</option>
                                    <option value="culture">문화</option>
                                    <option value="sports">스포츠</option>
                                </select>
                            </div>
                            <input type="text" class="filter-input" placeholder="기사 제목 검색..." id="articleSearchInput" oninput="filterArticles()">
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table" id="articlesTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>제목</th>
                                    <th>카테고리</th>
                                    <th>라벨</th>
                                    <th>등록일</th>
                                    <th>작업</th>
                                </tr>
                            </thead>
                            <tbody id="articlesTableBody">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                    <div class="table-footer">
                        <div class="table-info">총 <strong id="articlesTotalCount">0</strong>개의 기사</div>
                        <div class="pagination" id="articlesPagination">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Topics Page -->
            <section class="page-section" id="page-topics">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <span class="material-symbols-outlined">category</span>
                            토픽 관리
                        </h2>
                        <div class="filter-bar">
                            <input type="text" class="filter-input" placeholder="토픽 검색..." id="topicSearchInput" oninput="filterTopics()">
                            <button class="btn btn-primary" onclick="openAddTopicModal()">
                                <span class="material-symbols-outlined">add</span>
                                토픽 추가
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table" id="topicsTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>토픽명</th>
                                    <th>기사 수</th>
                                    <th>긍정/부정/중립</th>
                                    <th>생성일</th>
                                    <th>작업</th>
                                </tr>
                            </thead>
                            <tbody id="topicsTableBody">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                    <div class="table-footer">
                        <div class="table-info">총 <strong id="topicsTotalCount">0</strong>개의 토픽</div>
                        <div class="pagination" id="topicsPagination">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Settings Page -->
            <section class="page-section" id="page-settings">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <span class="material-symbols-outlined">settings</span>
                            시스템 설정
                        </h2>
                    </div>
                    <div class="card-body">
                        <div class="settings-section">
                            <h3 class="settings-section-title">자동화 설정</h3>
                            <p class="settings-section-desc">시스템 자동화 기능을 활성화하거나 비활성화합니다.</p>
                            <div class="settings-list">

                                <!-- 1) news_full_pipeline -->
                                <div class="settings-item">
                                    <div class="settings-item-info">
                                        <div class="settings-item-title">뉴스 파이프라인 (크롤링+트렌드)</div>
                                        <div class="settings-item-desc">1시간마다 기사 크롤링 및 트렌드 분석을 실행합니다.</div>
                                    </div>
                                    <label class="switch">
                                        <input type="checkbox"
                                                id="toggle_news_full_pipeline"
                                                data-job-id="news_full_pipeline"
                                                onchange="onSchedulerToggle(this)">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <!-- 2) session_timeout_job -->
                                <div class="settings-item">
                                    <div class="settings-item-info">
                                        <div class="settings-item-title">세션 타임아웃 정리</div>
                                        <div class="settings-item-desc">1분마다 세션 타임아웃을 검사하고 종료 처리합니다.</div>
                                    </div>
                                    <label class="switch">
                                        <input type="checkbox"
                                                id="toggle_session_timeout_job"
                                                data-job-id="session_timeout_job"
                                                onchange="onSchedulerToggle(this)">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <!-- 3) polarity_daily_0500 -->
                                <div class="settings-item">
                                    <div class="settings-item-info">
                                        <div class="settings-item-title">토픽 성향 분석</div>
                                        <div class="settings-item-desc">매일 05:00에 토픽 성향(긍/부정)을 분석합니다.</div>
                                    </div>
                                    <label class="switch">
                                        <input type="checkbox"
                                                id="toggle_polarity_daily_0500"
                                                data-job-id="polarity_daily_0500"
                                                onchange="onSchedulerToggle(this)">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>
</div>

<!-- User Edit Modal -->
<div class="modal-overlay" id="userEditModal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">사용자 정보 수정</h3>
            <button class="modal-close" onclick="closeModal('userEditModal')">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">이름</label>
                <input type="text" class="form-input" id="editUserName" placeholder="사용자 이름">
            </div>
            <div class="form-group">
                <label class="form-label">이메일</label>
                <input type="email" class="form-input" id="editUserEmail" placeholder="이메일 주소">
            </div>
            <div class="form-group">
                <label class="form-label">상태</label>
                <select class="form-select" id="editUserStatus">
                    <option value="active">활성</option>
                    <option value="inactive">비활성</option>
                    <option value="suspended">정지</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('userEditModal')">취소</button>
            <button class="btn btn-primary" onclick="saveUserEdit()">저장</button>
        </div>
    </div>
</div>

<!-- User Activity Modal -->
<div class="modal-overlay" id="userActivityModal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">사용자 활동 내역</h3>
            <button class="modal-close" onclick="closeModal('userActivityModal')">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="modal-body">
            <div class="activity-list" id="userActivityList">
                <!-- Populated by JS -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('userActivityModal')">닫기</button>
        </div>
    </div>
</div>

<!-- Article Edit Modal -->
<div class="modal-overlay" id="articleEditModal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">기사 정보 수정</h3>
            <button class="modal-close" onclick="closeModal('articleEditModal')">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">기사 제목</label>
                <input type="text" class="form-input" id="editArticleTitle" placeholder="기사 제목">
            </div>
            <div class="form-group">
                <label class="form-label">기사 본문</label>
                <textarea type="text" class="form-input" id="editArticleContent" placeholder="기사 본문" wrap="soft"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">카테고리</label>
                <select class="form-select" id="editArticleCategory">
                    <option value="society">사회/경제</option>
                    <option value="politics">정치</option>
                    <option value="world">국제</option>
                    <option value="culture">문화</option>
                    <option value="sports">스포츠</option>
                    <option value="local">지역</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('articleEditModal')">취소</button>
            <button class="btn btn-primary" onclick="saveArticleEdit()">저장</button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" id="deleteConfirmModal">
    <div class="modal" style="max-width: 24rem;">
        <div class="modal-header">
            <h3 class="modal-title">비활성화 확인</h3>
            <button class="modal-close" onclick="closeModal('deleteConfirmModal')">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="modal-body">
            <p id="deleteConfirmMessage">정말로 이 항목을 비활성화하시겠습니까?</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('deleteConfirmModal')">아니요</button>
            <button class="btn btn-danger" id="confirmDeleteBtn">예</button>
        </div>
    </div>
</div>

<!-- Log Detail Modal -->
<div class="modal-overlay" id="logDetailModal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">로그 상세</h3>
            <button class="modal-close" onclick="closeModal('logDetailModal')">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">시간</label>
                <div id="logDetailTime" style="color: var(--gray-600);"></div>
            </div>
            <div class="form-group">
                <label class="form-label">유형</label>
                <div id="logDetailType"></div>
            </div>
            <div class="form-group">
                <label class="form-label">소스</label>
                <div id="logDetailSource" style="color: var(--gray-600);"></div>
            </div>
            <div class="form-group">
                <label class="form-label">메시지</label>
                <div id="logDetailMessage" class="log-message" style="white-space: pre-wrap; max-width: 100%;"></div>
            </div>
            <div class="form-group">
                <label class="form-label">스택 트레이스</label>
                <pre id="logDetailStack" style="background: var(--gray-100); padding: 1rem; border-radius: 0.5rem; font-size: 0.75rem; overflow-x: auto; color: var(--gray-700);"></pre>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('logDetailModal')">닫기</button>
        </div>
    </div>
</div>

<!-- Topic Edit Modal -->
<div class="modal-overlay" id="topicEditModal">
    <div class="modal" style="max-width: 40rem;">
        <div class="modal-header">
            <h3 class="modal-title">토픽 수정</h3>
            <button class="modal-close" onclick="closeModal('topicEditModal')">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">토픽명</label>
                <input type="text" class="form-input" id="editTopicName" placeholder="토픽 이름">
            </div>
            <div class="form-group">
                <label class="form-label">포함 기사 및 감성 라벨</label>
                <div class="topic-articles-list" id="topicArticlesList">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('topicEditModal')">취소</button>
            <button class="btn btn-primary" onclick="saveTopicEdit()">저장</button>
        </div>
    </div>
</div>

<!-- Add Topic Modal -->
<div class="modal-overlay" id="addTopicModal">
    <div class="modal" style="max-width: 32rem;">
        <div class="modal-header">
            <h3 class="modal-title">새 토픽 추가</h3>
            <button class="modal-close" onclick="closeModal('addTopicModal')">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">토픽명</label>
                <input type="text" class="form-input" id="newTopicName" placeholder="새 토픽 이름">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('addTopicModal')">취소</button>
            <button class="btn btn-primary" onclick="addNewTopic()">추가</button>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<script>
const PAGE_SIZE = 10;
let logsCurrentPage = 1;
const ARTICLE_PAGE_SIZE = 10;
let articlesCurrentPage = 1;

let logsNextCursor = null;
let logsHasMore = false;

let articlesNextCursor = null;
let articlesHasMore = false;

const LOGS_FETCH_SIZE = 200;
const ARTICLES_FETCH_SIZE = 200;

let logsData = [];
let articlesData = [];
let filteredLogs = [];
let filteredArticles = [];
let usersData = [];          // ✅ const 말고 let
let filteredUsers = [];      // ✅ filteredUsers도 전역으로 유지
let usersCurrentPage = 1;    // ✅ 너 코드에서 쓰는데 선언이 없음
const USERS_PAGE_SIZE = 10;  // (원하면 PAGE_SIZE 재사용해도 됨)
let topicsData = [];          // ✅ 전역 선언 필수
let filteredTopics = [];      // 이미 있으면 중복 제거
let topicsCurrentPage = 1;    // 토픽 페이징 쓰면 선언
const TOPICS_PAGE_SIZE = 10;  // 토픽 페이징

function normalizeLabel(label) {
  // label이 object면 흔히 오는 키들에서 문자열 뽑기
  if (label && typeof label === "object") {
    label = label.value ?? label.label ?? label.name ?? label.type ?? "";
  }
  return String(label ?? "").trim().toLowerCase();
}

function normalizeCategory(c) {
  const v = String(c ?? '').toLowerCase().trim();
  const map = {
    "사회/경제/산업": "society",
    "사회": "society",
    "경제": "society",
    "정치": "politics",
    "국제": "world",
    "문화": "culture",
    "스포츠": "sports",
    "지역": "local"
  };
  return map[v] || v; // 이미 society 같은 값이면 그대로
}

function normalizeTopics(rawTopics) {
  const arr = Array.isArray(rawTopics) ? rawTopics : [];

  return arr.map((t) => {
    // ✅ 케이스 1: 이미 프론트 모델이면 그대로
    if (t && t.id && t.name && Array.isArray(t.articles)) {
      return {
        id: String(t.id),
        name: String(t.name ?? ""),
        articles: t.articles.map(a => ({
          id: String(a.id ?? a.article_id ?? ""),
          title: String(a.title ?? a.article_title ?? ""),
          sentiment: String(a.sentiment ?? a.polarity ?? "neutral")
        })),
        date: String(t.date ?? "")
      };
    }

    // ✅ 케이스 2: ES raw(topic_polarity) 형태
    const id = String(t.topic_id ?? t.id ?? "");
    const name = String(t.topic_name ?? t.name ?? "");
    const date = formatDateOnly(t.calculated_at ?? t.date);

    const pos = Array.isArray(t.positive_articles) ? t.positive_articles : [];
    const neg = Array.isArray(t.negative_articles) ? t.negative_articles : [];
    const neu = Array.isArray(t.neutral_articles) ? t.neutral_articles : []; // 혹시 있다면

    // ES raw는 title이 없을 수 있음 → 일단 id만 박아도 렌더는 되게
    const articles = [
      ...pos.map(a => ({
        id: String(a.article_id ?? a.id ?? ""),
        title: String(a.title ?? a.article_title ?? a.article_id ?? ""),
        sentiment: "positive"
      })),
      ...neg.map(a => ({
        id: String(a.article_id ?? a.id ?? ""),
        title: String(a.title ?? a.article_title ?? a.article_id ?? ""),
        sentiment: "negative"
      })),
      ...neu.map(a => ({
        id: String(a.article_id ?? a.id ?? ""),
        title: String(a.title ?? a.article_title ?? a.article_id ?? ""),
        sentiment: "neutral"
      })),
    ].filter(a => a.id); // 빈 id 제거

    return { id, name, articles, date };
  });
}

function formatDateOnly(v) {
  if (!v) return "";
  // ISO string "2026-01-13T..." → "2026-01-13"
  if (typeof v === "string") return v.slice(0, 10);
  // epoch millis
  if (typeof v === "number") {
    try { return new Date(v).toISOString().slice(0,10); } catch(e){ return ""; }
  }
  return "";
}

function loadAdminLogs() {
  return $.ajax({
    url: "/api/admin/admin_logs",
    method: "GET",
    dataType: "json",
    success: function (data) {
      console.log("admin_logs:", data);

      logsData = data.log || [];
      articlesData = data.article || [];
      usersData = data.users || [];

      // ✅ topics 정규화
      topicsData = normalizeTopics(data.topics || []);
      filteredTopics = [...topicsData];

      // cursor/has_more ...
      logsNextCursor = data.log_next_cursor ?? null;
      logsHasMore = Boolean(data.log_has_more);
      articlesNextCursor = data.article_next_cursor ?? null;
      articlesHasMore = Boolean(data.article_has_more);

      filteredLogs = [...logsData];
      filteredArticles = [...articlesData];
      logsCurrentPage = 1;
      articlesCurrentPage = 1;
      usersCurrentPage = 1;
      topicsCurrentPage = 1;

      // ✅ 각 섹션 렌더는 데이터 셋업 이후
      filterLogs();
      updateErrorCount();
      filterArticles();
      filterUsers();

      // ✅ 토픽은 여기서 렌더 (이게 제일 중요)
      renderTopics();
    },
    error: function (xhr) {
      console.error("loadAdminLogs failed:", xhr.status, xhr.responseText);
      logsData = [];
      filteredLogs = [];
      renderLogs();
      updateErrorCount();

      // ✅ 토픽도 실패 시 빈 렌더
      topicsData = [];
      filteredTopics = [];
      renderTopics();
    }
  });
}

function fetchMoreLogs() {
  if (!logsHasMore) return Promise.resolve(false);

  return $.ajax({
    url: "/api/admin/logs_more",
    method: "GET",
    dataType: "json",
    data: {
      cursor: logsNextCursor,
      size: LOGS_FETCH_SIZE
    }
  }).then(res => {
    const items = res.items || [];
    if (items.length) logsData.push(...items);

    logsNextCursor = res.next_cursor ?? null;
    logsHasMore = Boolean(res.has_more);

    return items.length > 0;
  }).catch(err => {
    console.error("fetchMoreLogs failed:", err);
    logsHasMore = false; // 실패 시 더 안 시도
    return false;
  });
}

function fetchMoreArticles() {
  if (!articlesHasMore) return Promise.resolve(false);

  return $.ajax({
    url: "/api/admin/articles_more",
    method: "GET",
    dataType: "json",
    data: {
      cursor: articlesNextCursor,
      size: ARTICLES_FETCH_SIZE
    }
  }).then(res => {
    const items = res.items || [];
    if (items.length) articlesData.push(...items);

    articlesNextCursor = res.next_cursor ?? null;
    articlesHasMore = Boolean(res.has_more);

    return items.length > 0;
  }).catch(err => {
    console.error("fetchMoreArticles failed:", err);
    articlesHasMore = false;
    return false;
  });
}

// State
let currentEditUserId = null;
let currentEditArticleId = null;
let currentEditTopicId = null;
let deleteCallback = null;

// Page Titles
const pageTitles = {
    dashboard: '대시보드 개요',
    logs: '시스템 로그',
    users: '사용자 관리',
    articles: '기사 관리',
    topics: '토픽 관리',
    settings: '시스템 설정'
};

document.addEventListener('DOMContentLoaded', () => {
  initDarkMode();
  initNavigation();
  navigateTo()
  loadAdminLogs();      
  updateErrorCount();
  loadSettings();
  loadSchedulerToggles();
});

// Dark Mode
function initDarkMode() {
    if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark');
    }
}

function toggleDarkMode() {
    document.body.classList.toggle('dark');
    localStorage.setItem('darkMode', document.body.classList.contains('dark'));
}

function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const collapsedMode = document.body.classList.contains('sidebar-collapsed');

  // 좁은 화면(접힘 모드)에서는 토글이 "고정 열기/닫기" 역할
  if (collapsedMode) {
    const isCollapsed = sidebar.classList.contains('collapsed');
    if (isCollapsed) {
      sidebar.classList.remove('collapsed');
      sidebarPinnedOpen = true;   // ✅ 고정 열기
    } else {
      sidebar.classList.add('collapsed');
      sidebarPinnedOpen = false;  // ✅ 고정 해제 + 닫기
    }
    return;
  }

  // 넓은 화면에서는 기존처럼 동작해도 되고, 필요 없으면 제거
  sidebar.classList.toggle('collapsed');
}

// Navigation
function initNavigation() {
    document.querySelectorAll('.nav-item[data-page]').forEach(item => {
        item.addEventListener('click', () => {
            const page = item.dataset.page;
            navigateTo(page);
        });
    });
}

function navigateTo(page) {
  const navBtn = document.querySelector(`.nav-item[data-page="${page}"]`);
  const section = document.getElementById(`page-${page}`);
  const titleEl = document.getElementById('pageTitle');
  const sidebar = document.getElementById('sidebar');

  if (!navBtn) {
    console.warn('[navigateTo] nav not found for page=', page);
    return;
  }
  if (!section) {
    console.warn('[navigateTo] section not found: id=', `page-${page}`);
    return;
  }

  // Update nav items
  document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
  navBtn.classList.add('active');

  // Update page sections
  document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
  section.classList.add('active');

  // Update title
  if (titleEl) titleEl.textContent = pageTitles[page] ?? page;

  // Close sidebar on mobile
  if (sidebar) sidebar.classList.remove('open');

  if (page === "settings") loadSchedulerToggles();
}

// Logs
function renderLogs() {
  const tbody = document.getElementById('logsTableBody');

  const total = filteredLogs.length;
  const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));

  // currentPage 보정
  logsCurrentPage = Math.min(Math.max(1, logsCurrentPage), totalPages);

  const start = (logsCurrentPage - 1) * PAGE_SIZE;
  const end = start + PAGE_SIZE;
  const pageItems = filteredLogs.slice(start, end);

  tbody.innerHTML = pageItems.map(log => `
    <tr>
      <td>${log.time ?? ''}</td>
      <td><span class="log-badge ${log.type}">${getLogTypeLabel(log.type)}</span></td>
      <td>${log.source ?? ''}</td>
      <td><span class="log-message">${escapeHtml(log.message ?? '')}</span></td>
      <td>
        <div class="action-btns">
          <button class="action-btn" onclick="viewLogDetail('${String(log.id).replace(/'/g, "\\'")}')" title="상세 보기">
            <span class="material-symbols-outlined">visibility</span>
          </button>
        </div>
      </td>
    </tr>
  `).join('');

  document.getElementById('logsTotalCount').textContent = total;

  renderLogsPagination(totalPages); // ✅ logs 전용 pagination
}

function getLogTypeLabel(type) {
    const labels = { error: '오류', warning: '경고', info: '정보', success: '성공' };
    return labels[type] || type;
}

function filterLogs() {
    const type = document.getElementById('logTypeFilter').value;
    const search = document.getElementById('logSearchInput').value.toLowerCase();
    
    filteredLogs = logsData.filter(log => {
        const matchesType = type === 'all' || log.type === type;
        const matchesSearch = log.message.toLowerCase().includes(search) || log.source.toLowerCase().includes(search);
        return matchesType && matchesSearch;
    });
    logsCurrentPage = 1; 
    renderLogs();
}

function refreshLogs() {
  showToast('로그를 새로고침했습니다.', 'info');
  loadAdminLogs(); // ✅ 이것만
}

function viewLogDetail(logId) {
  const key = String(logId);
  const log = (logsData || []).find(l => String(l.id) === key);

  console.log("clicked:", key, "found:", log);
  if (!log) return;

  document.getElementById('logDetailTime').textContent = log.time ?? "";
  document.getElementById('logDetailType').innerHTML =
    `<span class="log-badge ${log.type}">${getLogTypeLabel(log.type)}</span>`;
  document.getElementById('logDetailSource').textContent = log.source ?? "";
  document.getElementById('logDetailMessage').textContent = log.message ?? "";
  document.getElementById('logDetailStack').textContent = log.stack || '스택 트레이스 없음';
  console.log(log.stack)
  openModal('logDetailModal');
}

function renderLogsPagination(totalPages) {
  const container = document.getElementById('logsPagination');
  const cur = logsCurrentPage;

  const windowSize = 5;
  let start = Math.max(1, cur - Math.floor(windowSize / 2));
  let end = Math.min(totalPages, start + windowSize - 1);
  start = Math.max(1, end - windowSize + 1);

  // ✅ 핵심: 마지막 페이지라도 logsHasMore면 next를 disabled 하지 않는다
  const disablePrev = (cur === 1);
  const disableNext = (cur === totalPages && !logsHasMore); // ✅ 변경

  let html = `
    <button class="page-btn" data-nav="prev" ${disablePrev ? 'disabled' : ''}>
      <span class="material-symbols-outlined" style="font-size:1rem;">chevron_left</span>
    </button>
  `;

  for (let p = start; p <= end; p++) {
    html += `<button class="page-btn ${p === cur ? 'active' : ''}" data-page="${p}">${p}</button>`;
  }

  html += `
    <button class="page-btn" data-nav="next" ${disableNext ? 'disabled' : ''}>
      <span class="material-symbols-outlined" style="font-size:1rem;">chevron_right</span>
    </button>
  `;

  container.innerHTML = html;
}


document.addEventListener('click', (e) => {
  const btn = e.target.closest('#logsPagination .page-btn');
  if (!btn) return;
  if (btn.hasAttribute('disabled')) return;

  const nav = btn.dataset.nav;
  const page = btn.dataset.page;
  const totalPagesNow = Math.max(1, Math.ceil(filteredLogs.length / PAGE_SIZE));

  let targetPage = logsCurrentPage;
  if (nav === 'prev') targetPage = Math.max(1, logsCurrentPage - 1);
  else if (nav === 'next') targetPage = Math.min(totalPagesNow + 1, logsCurrentPage + 1); // ✅ +1 허용 (추가 fetch 대비)
  else if (page) targetPage = parseInt(page, 10) || 1;

  const requiredCount = targetPage * PAGE_SIZE;

  // ✅ 일단 현재 필터 기준으로 부족하면, ES에서 더 가져온 뒤 다시 필터/렌더
  const ensureAndRender = () => {
    // 필터는 logsData 기준으로 다시 계산해야 함
    // (filterLogs는 logsCurrentPage=1을 해버리므로, 페이지 유지하려면 아래처럼 직접 계산)
    const type = document.getElementById('logTypeFilter')?.value ?? 'all';
    const search = (document.getElementById('logSearchInput')?.value ?? '').toLowerCase().trim();

    filteredLogs = (logsData || []).filter(log => {
      const lt = String(log.type ?? '');
      const msg = String(log.message ?? '').toLowerCase();
      const src = String(log.source ?? '').toLowerCase();
      const matchesType = type === 'all' || lt === type;
      const matchesSearch = !search || msg.includes(search) || src.includes(search);
      return matchesType && matchesSearch;
    });

    logsCurrentPage = targetPage;
    renderLogs();
    updateErrorCount();
  };

  if (requiredCount <= filteredLogs.length) {
    logsCurrentPage = targetPage;
    renderLogs();
    return;
  }

  // ✅ 부족 + 더 가져올 수 있으면 반복 fetch
  if (!logsHasMore) {
    // 더 없는데 넘어가려는 경우: 마지막 페이지로 보정
    logsCurrentPage = Math.max(1, Math.ceil(filteredLogs.length / PAGE_SIZE));
    renderLogs();
    return;
  }

  showToast('추가 로그를 불러오는 중...', 'info');

  const fetchLoop = () => {
    return fetchMoreLogs().then(added => {
      // 추가로 받아온 뒤 필터 적용하면 filteredLogs가 늘어날 수 있음
      // 필요한 만큼 확보됐으면 렌더
      // (매번 필터/카운트 확인)
      const type = document.getElementById('logTypeFilter')?.value ?? 'all';
      const search = (document.getElementById('logSearchInput')?.value ?? '').toLowerCase().trim();

      const tmpFiltered = (logsData || []).filter(log => {
        const lt = String(log.type ?? '');
        const msg = String(log.message ?? '').toLowerCase();
        const src = String(log.source ?? '').toLowerCase();
        const matchesType = type === 'all' || lt === type;
        const matchesSearch = !search || msg.includes(search) || src.includes(search);
        return matchesType && matchesSearch;
      });

      if (requiredCount <= tmpFiltered.length) {
        ensureAndRender();
        return;
      }

      // 더 없거나, 이번에 추가가 없으면 종료
      if (!logsHasMore || !added) {
        // 가능한 마지막 페이지로 이동
        filteredLogs = tmpFiltered;
        logsCurrentPage = Math.max(1, Math.ceil(filteredLogs.length / PAGE_SIZE));
        renderLogs();
        updateErrorCount();
        return;
      }

      // 계속 가져오기
      return fetchLoop();
    });
  };

  fetchLoop();
});


function updateErrorCount() {
    const errorCount = logsData.filter(l => l.type === 'error').length;
    document.getElementById('errorCount').textContent = errorCount;
    // document.getElementById('error_stat_value').textContent = errorCount;
}

// Users
function renderUsers() {
  const tbody = document.getElementById('usersTableBody');

  tbody.innerHTML = filteredUsers.map(user => {
    const id = String(user.id ?? user.user_id ?? ''); // ✅ id 통일
    const name = String(user.name ?? user.user_name ?? '');
    const email = String(user.email ?? user.user_email ?? '');
    const joinDate = user.joinDate ?? user.join_date ?? user.joined_at ?? '';
    const lastActive = user.lastActive ?? user.last_active ?? user.lastActiveAt ?? '';
    const status = user.status ?? (user.is_active ? 'active' : 'inactive');

    return `
      <tr>
        <td>
          <div class="user-cell">
            <div class="user-avatar">${escapeHtml(name ? name.charAt(0) : '?')}</div>
            <div class="user-details">
              <div class="user-name">${escapeHtml(name)}</div>
              <div class="user-email">${escapeHtml(email)}</div>
            </div>
          </div>
        </td>
        <td>${escapeHtml(String(joinDate))}</td>
        <td>${escapeHtml(String(lastActive))}</td>
        <td><span class="status-badge ${escapeHtml(status)}">${getStatusLabel(status)}</span></td>
        <td>
          <div class="action-btns">
            <button class="action-btn delete" onclick="confirmDeleteUser('${id}')" title="삭제">
              <span class="material-symbols-outlined">delete</span>
            </button>
          </div>
        </td>
      </tr>
    `;
  }).join('');

  document.getElementById('usersTotalCount').textContent = filteredUsers.length;
  renderPagination('usersPagination', filteredUsers.length);
}


function getStatusLabel(status) {
    const labels = { active: '활성', inactive: '비활성' };
    return labels[status] || status;
}

function filterUsers() {
  const status = document.getElementById('userStatusFilter')?.value ?? 'all';
  const search = (document.getElementById('userSearchInput')?.value ?? '').toLowerCase().trim();

  filteredUsers = (usersData || []).filter(u => {
    const name = String(u.name ?? u.user_name ?? '').toLowerCase();
    const email = String(u.email ?? u.user_email ?? '').toLowerCase();
    const st = String(u.status ?? (Number(u.is_active) === 1 ? 'active' : 'inactive'));

    const matchesStatus = status === 'all' || st === status;
    const matchesSearch = !search || name.includes(search) || email.includes(search);
    return matchesStatus && matchesSearch;
  });

  usersCurrentPage = 1;
  renderUsers();
}

function editUser(userId) {
    const user = usersData.find(u => u.id === userId);
    if (!user) return;
    
    currentEditUserId = userId;
    document.getElementById('editUserName').value = user.name;
    document.getElementById('editUserEmail').value = user.email;
    document.getElementById('editUserStatus').value = user.status;
    
    openModal('userEditModal');
}

function saveUserEdit() {
    const user = usersData.find(u => u.id === currentEditUserId);
    if (!user) return;
    
    user.name = document.getElementById('editUserName').value;
    user.email = document.getElementById('editUserEmail').value;
    user.status = document.getElementById('editUserStatus').value;
    
    filterUsers();
    closeModal('userEditModal');
    showToast('사용자 정보가 수정되었습니다.', 'success');
}

function viewUserActivity(userId) {
    const list = document.getElementById('userActivityList');
    list.innerHTML = userActivities.map(activity => `
        <div class="activity-item">
            <div class="activity-icon ${activity.type}">
                <span class="material-symbols-outlined">${getActivityIcon(activity.type)}</span>
            </div>
            <div class="activity-content">
                <div class="activity-title">${escapeHtml(activity.title)}</div>
                <div class="activity-desc">${escapeHtml(activity.desc)}</div>
            </div>
            <div class="activity-time">${activity.time}</div>
        </div>
    `).join('');
    
    openModal('userActivityModal');
}

function getActivityIcon(type) {
    const icons = { login: 'login', view: 'visibility', action: 'edit' };
    return icons[type] || 'info';
}

function confirmDeleteUser(userId) {
  const user = usersData.find(
    u => String(u.id ?? u.user_id) === String(userId)
  );
  if (!user) return;

  // 현재 상태 판단
  const isActive = user.is_active === 1 || user.status === "active";

  const name = user.name ?? user.user_name ?? '';
  const actionText = isActive ? "비활성화" : "활성화";

  document.getElementById('deleteConfirmMessage').textContent =
    `"${name}" 사용자를 ${actionText}하시겠습니까?`;

  deleteCallback = () => {
    $.ajax({
      url: `/api/admin/toggle_users/${encodeURIComponent(userId)}`,
      method: "PATCH",   // ✅ toggle이므로 PATCH가 의미상 적절
      success: (res) => {
        // ✅ 서버 결과 기준으로 상태 반영
        const u = usersData.find(x => String(x.id ?? x.user_id) === String(userId));
        if (u) {
          const newActive = Number(res.is_active);   // ✅ 핵심
          u.is_active = newActive;
          u.status = newActive === 1 ? "active" : "inactive";
        }

        filterUsers();
        showToast(`사용자가 ${actionText}되었습니다.`, 'success');
        closeModal('deleteConfirmModal');
      },
      error: (xhr) => {
        console.error("toggle user failed:", xhr.status, xhr.responseText);
        showToast(`사용자 ${actionText}에 실패했습니다.`, 'error');
      }
    });
  };
  document.getElementById('confirmDeleteBtn').onclick = deleteCallback;
  openModal('deleteConfirmModal');
}

function renderArticles() {
  const tbody = document.getElementById('articlesTableBody');

  const total = filteredArticles.length;
  const totalPages = Math.max(1, Math.ceil(total / ARTICLE_PAGE_SIZE));
  articlesCurrentPage = Math.min(Math.max(1, articlesCurrentPage), totalPages);

  const start = (articlesCurrentPage - 1) * ARTICLE_PAGE_SIZE;
  const end = start + ARTICLE_PAGE_SIZE;
  const pageItems = filteredArticles.slice(start, end);

  tbody.innerHTML = pageItems.map(article => {
    const id = String(article.id ?? article.article_id ?? "");
    const title = String(article.title ?? article.article_title ?? "");
    const date = String(article.date ?? article.upload_date ?? article.published_date ?? "");

    const rawCategory = article.category ?? article.article_category ?? article.article_label?.category ?? "";
    const category = normalizeCategory(rawCategory);
    const status = Number(article.status ?? article.article_status ?? 5); // 기본 활성
    const isActive = status >= 5;
    const labelsArr =
      article.labels ??
      article.article_label?.labels ??
      article.article_label?.label ??
      [];

    return `
      <tr>
        <td class="col-id">
          <a href="/article/${encodeURIComponent(id)}" class="article-id-link" title="${escapeHtml(id)}">
            ${escapeHtml(id)}
          </a>
        </td>

        <td class="col-title">
          <span class="article-title-cell" title="${escapeHtml(title)}">${escapeHtml(title)}</span>
        </td>

        <td class="col-category">
          <span class="label-chip ${escapeHtml(category)}">${getCategoryLabel(category)}</span>
        </td>

        <td>
            <span class="status-badge ${isActive ? 'active' : 'inactive'}">
                ${isActive ? '활성' : '비활성'}
            </span>
        </td>


        <td class="col-date" title="${escapeHtml(date)}">${escapeHtml(date)}</td>

        <td class="col-actions">
          <div class="action-btns">
            <button type="button"
                class="action-btn"
                data-article-action="edit"
                data-article-id="${escapeHtml(id)}"
                title="기사 편집">
                <span class="material-symbols-outlined">edit</span>
            </button>
            <button type="button"
                class="action-btn ${isActive ? 'delete' : ''}"
                data-article-action="toggle"
                data-article-id="${escapeHtml(id)}"
                data-article-next="${isActive ? 0 : 5}"
                title="${isActive ? '비활성화' : '활성화'}">
                <span class="material-symbols-outlined">${isActive ? 'visibility_off' : 'visibility'}</span>
            </button>
          </div>
        </td>
      </tr>
    `;
  }).join('');

  document.getElementById('articlesTotalCount').textContent = total;
  renderArticlesPagination(totalPages);
}

function renderArticlesPagination(totalPages) {
  const container = document.getElementById('articlesPagination');
  const cur = articlesCurrentPage;

  const windowSize = 5;
  let start = Math.max(1, cur - Math.floor(windowSize / 2));
  let end = Math.min(totalPages, start + windowSize - 1);
  start = Math.max(1, end - windowSize + 1);

  const disablePrev = (cur === 1);
  const disableNext = (cur === totalPages && !articlesHasMore); // ✅ 핵심

  let html = `
    <button class="page-btn" data-article-nav="prev" ${disablePrev ? 'disabled' : ''}>
      <span class="material-symbols-outlined" style="font-size:1rem;">chevron_left</span>
    </button>
  `;

  for (let p = start; p <= end; p++) {
    html += `<button class="page-btn ${p === cur ? 'active' : ''}" data-article-page="${p}">${p}</button>`;
  }

  html += `
    <button class="page-btn" data-article-nav="next" ${disableNext ? 'disabled' : ''}>
      <span class="material-symbols-outlined" style="font-size:1rem;">chevron_right</span>
    </button>
  `;

  container.innerHTML = html;
}

function refilterArticlesKeepPage() {
  const category = document.getElementById('articleCategoryFilter')?.value ?? 'all';
  const search = (document.getElementById('articleSearchInput')?.value ?? '').toLowerCase().trim();

  filteredArticles = (articlesData || []).filter(a => {
    const aCategory = normalizeCategory(a.category ?? a.article_category ?? a.article_label?.category);
    const aTitle = String(a.title ?? a.article_title ?? '').toLowerCase();

    const matchesCategory = category === 'all' || aCategory === String(category).toLowerCase();
    const matchesSearch = !search || aTitle.includes(search);

    return matchesCategory && matchesSearch;
  });
}

function getCategoryLabel(category) {
    const labels = { society: '사회/경제', politics: '정치', world: '국제', culture: '문화', sports: '스포츠', local :'지역'};
    return labels[category] || category;
}

function getLabelClass(label) {
    const classes = { positive: 'sports', negative: 'politics', neutral: 'society', breaking: 'economy', exclusive: 'culture' };
    return classes[label] || 'society';
}

function getLabelText(label) {
    const texts = { positive: '긍정', negative: '부정', neutral: '중립', breaking: '속보', exclusive: '단독' };
    return texts[label] || label;
}

function filterArticles() {
  const category = document.getElementById('articleCategoryFilter')?.value ?? 'all';
  const search = (document.getElementById('articleSearchInput')?.value ?? '').toLowerCase().trim();

  filteredArticles = (articlesData || []).filter(a => {
    const aCategory = normalizeCategory(a.category ?? a.article_category ?? a.article_label?.category);
    const aTitle = String(a.title ?? a.article_title ?? '').toLowerCase();

    const matchesCategory = category === 'all' || aCategory === String(category).toLowerCase();
    const matchesSearch = !search || aTitle.includes(search);

    return matchesCategory && matchesSearch;
  });

  articlesCurrentPage = 1;
  renderArticles();
}

function editArticle(articleId) {
  const idStr = String(articleId);

  // 목록에서 메타 찾기(없어도 상세 조회는 가능하게)
  const listItem = (articlesData || []).find(a => String(a.id ?? a.article_id) === idStr);

  currentEditArticleId = idStr;

  // 1) 모달을 먼저 열고 로딩 상태 표시
  document.getElementById('editArticleTitle').value =
    (listItem?.title ?? listItem?.article_title ?? '불러오는 중...');
  document.getElementById('editArticleCategory').value =
    normalizeCategory(listItem?.category ?? listItem?.article_category ?? 'society');

  // (선택) 본문 textarea가 있으면 초기화
  const contentEl = document.getElementById('editArticleContent');
  if (contentEl) contentEl.value = '불러오는 중...';

  // 라벨 체크박스 초기화
  document.querySelectorAll('#articleEditModal input[type="checkbox"]').forEach(cb => cb.checked = false);

  // 목록 데이터에 labels가 있으면 일단 반영(상세에서 덮어쓸 수 있음)
  const seedLabels = listItem?.labels ?? [];
  (Array.isArray(seedLabels) ? seedLabels : [seedLabels]).forEach(l => {
    const label = normalizeLabel(l);
    if (!label) return;
    const cbId = 'label' + label.charAt(0).toUpperCase() + label.slice(1);
    const cb = document.getElementById(cbId);
    if (cb) cb.checked = true;
  });

  openModal('articleEditModal');

  // 2) 상세 조회(본문 포함) - 성공하면 모달 값 업데이트
  $.ajax({
    url: `/api/admin/article_detail/${encodeURIComponent(idStr)}`,
    method: "GET",
    dataType: "json",
    success: (res) => {
      // title/category
      if (res?.title != null) document.getElementById('editArticleTitle').value = res.title;
      if (res?.category != null) document.getElementById('editArticleCategory').value = normalizeCategory(res.category);

      // content
      if (contentEl && res?.article_content != null) contentEl.value = res.article_content;
    },
    error: (xhr) => {
      console.error("editArticle detail fetch failed:", xhr.status, xhr.responseText);
      showToast('기사 상세를 불러오지 못했습니다.', 'error');
      // 모달은 열린 채로 두고, 목록 데이터로 편집이라도 가능하게 유지
      if (contentEl && contentEl.value === '불러오는 중...') contentEl.value = '';
    }
  });
}

function saveArticleEdit() {
  const articleId = String(currentEditArticleId ?? '');
  if (!articleId) return;

  const title = document.getElementById('editArticleTitle').value.trim();
  const content = document.getElementById('editArticleContent').value.trim();
  const category = document.getElementById('editArticleCategory').value;

  if (!title) {
    showToast('제목을 입력해주세요.', 'warning');
    return;
  }

  $.ajax({
    url: `/api/admin/edit_articles/${encodeURIComponent(articleId)}`,
    method: "PATCH",
    contentType: "application/json",
    dataType: "json",
    data: JSON.stringify({
      title,
      content,
      category,

      // labels는 일단 제외(원하면 다음 단계로 붙이자)
    }),
    success: (res) => {
      // ✅ 로컬 반영 (화면 즉시)
      const a = (articlesData || []).find(x => String(x.id ?? x.article_id) === articleId);
      if (a) {
        a.title = res.title ?? title;
        a.category = res.category ?? category;
      }

      // ✅ 필터/렌더 갱신
      refilterArticlesKeepPage();
      renderArticles();

      closeModal('articleEditModal');
      showToast('기사 정보가 저장되었습니다.', 'success');
    },
    error: (xhr) => {
      console.error("saveArticleEdit failed:", xhr.status, xhr.responseText);
      showToast('기사 저장에 실패했습니다.', 'error');
    }
  });
}

function confirmToggleArticleStatus(articleId, nextStatus) {
  const id = String(articleId);
  const next = Number(nextStatus); // 0 or 1

  const article = (articlesData || []).find(a => String(a.id ?? a.article_id) === id);
  const title = article?.title ?? article?.article_title ?? id;

  const actionText = next === 0 ? "비활성화(노출 제외)" : "활성화(노출 포함)";

  document.getElementById('deleteConfirmMessage').textContent =
    `"${title}" 기사를 ${actionText} 하시겠습니까?`;

  document.getElementById('confirmDeleteBtn').onclick = () => {
    $.ajax({
      url: `/api/admin/hide_articles/${encodeURIComponent(id)}`,
      method: "PATCH",
      contentType: "application/json",
      dataType: "json",
      data: JSON.stringify({ status: next }),
      success: (res) => {
        const newStatus = Number(res.status ?? next);
        const idStr = String(id);

        // 1️⃣ articlesData 갱신
        const a = articlesData.find(x => String(x.id ?? x.article_id) === idStr);
        if (a) a.status = newStatus;

        // 2️⃣ filteredArticles도 갱신 (이게 핵심)
        const f = filteredArticles.find(x => String(x.id ?? x.article_id) === idStr);
        if (f) f.status = newStatus;

        // 3️⃣ 필터 재계산 (status 조건 반영)
        refilterArticlesKeepPage();

        // 4️⃣ 페이지 보정
        const last = Math.max(1, Math.ceil(filteredArticles.length / ARTICLE_PAGE_SIZE));
        articlesCurrentPage = Math.min(articlesCurrentPage, last);

        // 5️⃣ 렌더
        loadAdminLogs();          // ✅ 바로 재렌더
        closeModal('deleteConfirmModal');
        showToast('상태가 변경되었습니다.', 'success');
        },
      error: (xhr) => {
        console.error("toggle article status failed:", xhr.status, xhr.responseText);
        showToast('상태 변경에 실패했습니다.', 'error');
      }
    });
  };

  openModal('deleteConfirmModal');
}

// Pagination (simplified)
function renderPagination(containerId, totalItems) {
    const container = document.getElementById(containerId);
    const totalPages = Math.ceil(totalItems / 10) || 1;
    
    let html = '<button class="page-btn"><span class="material-symbols-outlined" style="font-size:1rem;">chevron_left</span></button>';
    for (let i = 1; i <= Math.min(totalPages, 5); i++) {
        html += `<button class="page-btn ${i === 1 ? 'active' : ''}">${i}</button>`;
    }
    html += '<button class="page-btn"><span class="material-symbols-outlined" style="font-size:1rem;">chevron_right</span></button>';
    
    container.innerHTML = html;
}

// Modal
function openModal(modalId) {
    document.getElementById(modalId).classList.add('active');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

// Toast
function showToast(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    const icons = {
        success: 'check_circle',
        error: 'error',
        warning: 'warning',
        info: 'info'
    };
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
        <div class="toast-icon">
            <span class="material-symbols-outlined">${icons[type]}</span>
        </div>
        <span class="toast-message">${escapeHtml(message)}</span>
    `;
    
    container.appendChild(toast);
    
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Utility
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function renderTopics() {
  const tbody = document.getElementById('topicsTableBody');
  const totalEl = document.getElementById('topicsTotalCount');

  if (!tbody) {
    console.warn("topicsTableBody not found");
    return;
  }

  const total = Array.isArray(filteredTopics) ? filteredTopics.length : 0;
  if (totalEl) totalEl.textContent = String(total);

  // ✅ 페이징(원치 않으면 이 block 삭제)
  const totalPages = Math.max(1, Math.ceil(total / TOPICS_PAGE_SIZE));
  topicsCurrentPage = Math.min(Math.max(1, topicsCurrentPage), totalPages);

  const start = (topicsCurrentPage - 1) * TOPICS_PAGE_SIZE;
  const end = start + TOPICS_PAGE_SIZE;
  const pageItems = (filteredTopics || []).slice(start, end);

  if (!pageItems.length) {
    tbody.innerHTML = `
      <tr>
        <td colspan="6" style="text-align:center; opacity:0.7; padding:16px;">
          표시할 토픽이 없습니다.
        </td>
      </tr>
    `;
    // pagination도 비우기
    const p = document.getElementById('topicsPagination');
    if (p) p.innerHTML = '';
    return;
  }

  tbody.innerHTML = pageItems.map(topic => {
    const id = String(topic.id ?? "");
    const name = String(topic.name ?? "");
    const date = String(topic.date ?? "");

    const arts = Array.isArray(topic.articles) ? topic.articles : [];

    const positive = arts.reduce((acc,a)=> acc + (a.sentiment === 'positive'), 0);
    const negative = arts.reduce((acc,a)=> acc + (a.sentiment === 'negative'), 0);
    const neutral  = arts.reduce((acc,a)=> acc + (a.sentiment === 'neutral'), 0);

    return `
      <tr>
        <td>${escapeHtml(id)}</td>
        <td><span class="article-title-cell">${escapeHtml(name)}</span></td>
        <td>${arts.length}</td>
        <td>
          <div class="topic-stats">
            <span class="topic-stat positive">긍정 ${positive}</span>
            <span class="topic-stat negative">부정 ${negative}</span>
            <span class="topic-stat neutral">중립 ${neutral}</span>
          </div>
        </td>
        <td>${escapeHtml(date)}</td>
        <td>
          <div class="action-btns">
            <button class="action-btn" data-topic-action="edit" data-topic-id="${escapeHtml(id)}" title="수정">
              <span class="material-symbols-outlined">edit</span>
            </button>
            <button class="action-btn delete" data-topic-action="delete" data-topic-id="${escapeHtml(id)}" title="삭제">
              <span class="material-symbols-outlined">delete</span>
            </button>
          </div>
        </td>
      </tr>
    `;
  }).join('');

  renderTopicsPagination(totalPages);
}


function filterTopics() {
  const el = document.getElementById('topicSearchInput');
  const search = (el?.value ?? '').toLowerCase().trim();

  filteredTopics = (topicsData || []).filter(topic => {
    const name = String(topic.name ?? '').toLowerCase();
    const id = String(topic.id ?? '').toLowerCase();
    return !search || name.includes(search) || id.includes(search);
  });

  topicsCurrentPage = 1;
  renderTopics();
}


function editTopic(topicId) {
  const topic = (topicsData || []).find(t => String(t.id) === String(topicId));
  if (!topic) return;

  currentEditTopicId = String(topicId);
  document.getElementById('editTopicName').value = topic.name ?? "";

  const list = document.getElementById('topicArticlesList');
  const arts = Array.isArray(topic.articles) ? topic.articles : [];

  list.innerHTML = arts.map((article, idx) => `
    <div class="topic-article-item" data-article-idx="${idx}">
      <span class="topic-article-title">${escapeHtml(article.title ?? article.id ?? '')}</span>
      <div class="topic-article-actions">
        <select data-article-idx="${idx}">
          <option value="positive" ${article.sentiment === 'positive' ? 'selected' : ''}>긍정</option>
          <option value="negative" ${article.sentiment === 'negative' ? 'selected' : ''}>부정</option>
          <option value="neutral"  ${article.sentiment === 'neutral'  ? 'selected' : ''}>중립</option>
        </select>
        <button class="topic-article-delete-btn" type="button" onclick="deleteTopicArticle(${idx})" title="기사 제거">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>
    </div>
  `).join('');

  openModal('topicEditModal');
}


function updateTopicArticleSentiment(select) {
    // This updates in real-time when saved
}

function deleteTopicArticle(articleIdx) {
    const topic = topicsData.find(t => t.id === currentEditTopicId);
    if (!topic) return;
    
    topic.articles.splice(articleIdx, 1);
    editTopic(currentEditTopicId); // Re-render the list
    showToast('기사가 토픽에서 제거되었습니다.', 'success');
}

async function saveTopicEdit() {
  const topic = topicsData.find(t => String(t.id) === String(currentEditTopicId));
  if (!topic) return;

  const newName = document.getElementById('editTopicName').value.trim();

  // 모달에서 선택된 sentiment 반영 (로컬)
  const selects = document.querySelectorAll('#topicArticlesList select');
  selects.forEach(select => {
    const idx = parseInt(select.dataset.articleIdx, 10);
    if (!Number.isNaN(idx) && topic.articles[idx]) {
      topic.articles[idx].sentiment = select.value;
    }
  });

  // ✅ 백엔드로 보낼 최종 articles 리스트 구성
  const payload = {
    name: newName,
    articles: (topic.articles || []).map(a => ({
      article_id: String(a.id),
      sentiment: a.sentiment || "neutral"
    }))
  };

  try {
    await patchTopic(currentEditTopicId, payload);

    // 성공 시 로컬도 확정 반영
    topic.name = newName;

    filterTopics();
    closeModal('topicEditModal');
    showToast('토픽이 저장되었습니다.', 'success');

    // (선택) 서버 기준으로 다시 로드하고 싶으면:
    // loadAdminLogs();

  } catch (e) {
    console.error("saveTopicEdit failed:", e);
    showToast('토픽 저장에 실패했습니다.', 'error');
  }
}

function openAddTopicModal() {
    document.getElementById('newTopicName').value = '';
    openModal('addTopicModal');
}

function addNewTopic() {
    const name = document.getElementById('newTopicName').value.trim();
    if (!name) {
        showToast('토픽 이름을 입력해주세요.', 'warning');
        return;
    }
    
    const newId = 'T' + String(topicsData.length + 1).padStart(3, '0');
    const today = new Date().toISOString().split('T')[0];
    
    topicsData.push({
        id: newId,
        name: name,
        articles: [],
        date: today
    });
    
    filterTopics();
    closeModal('addTopicModal');
    showToast('새 토픽이 추가되었습니다.', 'success');
}

function confirmDeleteTopic(topicId) {
    const topic = topicsData.find(t => t.id === topicId);
    if (!topic) return;
    
    document.getElementById('deleteConfirmMessage').textContent = `"${topic.name}" 토픽을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.`;
    deleteCallback = () => {
        const index = topicsData.findIndex(t => t.id === topicId);
        if (index > -1) {
            topicsData.splice(index, 1);
            filterTopics();
            showToast('토픽이 삭제되었습니다.', 'success');
        }
        closeModal('deleteConfirmModal');
    };
    document.getElementById('confirmDeleteBtn').onclick = deleteCallback;
    
    openModal('deleteConfirmModal');
}

function patchTopic(topicId, payload) {
  return $.ajax({
    url: `/api/admin/edit_topics/${encodeURIComponent(topicId)}`,
    method: "PATCH",
    contentType: "application/json",
    dataType: "json",
    data: JSON.stringify(payload),
    success: function(){
        loadAdminLogs();
    }
  });
}

// Settings
async function saveSettings() {
  const settings = {
    autoClassify: document.getElementById('settingAutoClassify').checked,
    autoTopic: document.getElementById('settingAutoTopic').checked,
    sentiment: document.getElementById('settingSentiment').checked,
    crawling: document.getElementById('settingCrawling').checked,
    notification: document.getElementById('settingNotification').checked,
    logCleanup: document.getElementById('settingLogCleanup').checked
  };

  // ✅ 일단 로컬 저장 (기존 유지)
  localStorage.setItem('adminSettings', JSON.stringify(settings));

  // ✅ "자동 크롤링"만 백엔드 스케줄러 연동
  // checked=true  => paused=false (resume)
  // checked=false => paused=true  (pause)
  const crawlingEnabled = settings.crawling;
  const paused = !crawlingEnabled;

  const el = document.getElementById('settingCrawling');
  const prev = !paused; // API 실패 시 롤백용(대략적인 이전값)

  try {
    await patchJobPaused("news_full_pipeline", paused);
    showToast(`자동 크롤링이 ${crawlingEnabled ? "활성화" : "비활성화"}되었습니다.`, "success");
  } catch (e) {
    console.error("patchJobPaused failed:", e);

    // ✅ 실패 시 UI 롤백
    if (el) el.checked = prev;
    settings.crawling = prev;
    localStorage.setItem('adminSettings', JSON.stringify(settings));

    showToast("자동 크롤링 설정 변경에 실패했습니다.", "error");
  }
}


function loadSettings() {
  const saved = localStorage.getItem('adminSettings');
  if (saved) {
    const settings = JSON.parse(saved);
    document.getElementById('settingAutoClassify').checked = settings.autoClassify ?? true;
    document.getElementById('settingAutoTopic').checked = settings.autoTopic ?? true;
    document.getElementById('settingSentiment').checked = settings.sentiment ?? true;
    document.getElementById('settingCrawling').checked = settings.crawling ?? false;
    document.getElementById('settingNotification').checked = settings.notification ?? false;
    document.getElementById('settingLogCleanup').checked = settings.logCleanup ?? true;
  }

  // ✅ 로컬 저장값보다 "실제 스케줄러 상태"가 우선
  loadSchedulerStatus();
}


async function loadSchedulerStatus() {
  try {
    const res = await $.ajax({
      url: "/api/admin/scheduler/jobs",
      method: "GET",
      dataType: "json"
    });

    // job 목록에서 target 찾기
    const jobs = res.jobs || [];

    // APScheduler pause 상태를 직접 주진 않아서 "다음 실행 시간"으로 간접 판단
    // next_run_time이 null이면 보통 paused (or removed) 가능성이 높음
    const crawlJob = jobs.find(j => j.id === "news_full_pipeline");
    const enabled = Boolean(crawlJob && crawlJob.next_run_time); 

    // ✅ "자동 크롤링" 스위치에 반영
    const el = document.getElementById("settingCrawling");
    if (el) el.checked = enabled;

  } catch (e) {
    console.error("loadSchedulerStatus failed:", e);
    showToast("스케줄러 상태를 불러오지 못했습니다.", "warning");
  }
}

async function patchJobPaused(jobId, paused) {
  return $.ajax({
    url: `/api/admin/scheduler/jobs/${encodeURIComponent(jobId)}`,
    method: "PATCH",
    contentType: "application/json",
    dataType: "json",
    data: JSON.stringify({ paused })
  });
}

// Close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(overlay => {

    overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
            overlay.classList.remove('active');
        }
    });
});

document.addEventListener('click', (e) => {
  const btn = e.target.closest('[data-article-action]');
  if (!btn) return;

  const action = btn.dataset.articleAction;
  const articleId = btn.dataset.articleId;

  if (action === 'edit') editArticle(articleId);
  else if (action === 'toggle') confirmToggleArticleStatus(articleId, btn.dataset.articleNext);
});

const COLLAPSE_BREAKPOINT = 1200; // 여기서 이하로 내려가면 자동 접기
const EDGE_HOTZONE = 12;          // 왼쪽 가장자리 감지 폭(px)

let sidebarPinnedOpen = false;    // 사용자가 수동으로 열어 고정했는지
let sidebarTempOpen = false;      // hover로 임시로 열렸는지

function setSidebarCollapsed(collapsed) {
  const sidebar = document.getElementById('sidebar');
  if (!sidebar) return;

  if (collapsed) {
    sidebar.classList.add('collapsed');
    document.body.classList.add('sidebar-collapsed');
    sidebarPinnedOpen = false;
  } else {
    sidebar.classList.remove('collapsed');
    document.body.classList.remove('sidebar-collapsed');
  }
}

function openSidebarTemp() {
  if (sidebarPinnedOpen) return;
  const sidebar = document.getElementById('sidebar');
  sidebar.classList.remove('collapsed');
  sidebarTempOpen = true;
}

function closeSidebarTemp() {
  if (sidebarPinnedOpen) return;
  const sidebar = document.getElementById('sidebar');
  sidebar.classList.add('collapsed');
  sidebarTempOpen = false;
}

// ✅ 화면 크기에 따라 자동 접기/펼치기
function applyResponsiveSidebar() {
  if (window.innerWidth <= COLLAPSE_BREAKPOINT) {
    setSidebarCollapsed(true);
  } else {
    setSidebarCollapsed(false);
  }
}

function renderTopicsPagination(totalPages) {
  const container = document.getElementById('topicsPagination');
  if (!container) return;

  const cur = topicsCurrentPage;
  const disablePrev = (cur === 1);
  const disableNext = (cur === totalPages);

  let html = `
    <button class="page-btn" data-topic-nav="prev" ${disablePrev ? 'disabled' : ''}>
      <span class="material-symbols-outlined" style="font-size:1rem;">chevron_left</span>
    </button>
  `;

  const windowSize = 5;
  let start = Math.max(1, cur - Math.floor(windowSize / 2));
  let end = Math.min(totalPages, start + windowSize - 1);
  start = Math.max(1, end - windowSize + 1);

  for (let p = start; p <= end; p++) {
    html += `<button class="page-btn ${p === cur ? 'active' : ''}" data-topic-page="${p}">${p}</button>`;
  }

  html += `
    <button class="page-btn" data-topic-nav="next" ${disableNext ? 'disabled' : ''}>
      <span class="material-symbols-outlined" style="font-size:1rem;">chevron_right</span>
    </button>
  `;

  container.innerHTML = html;
}

document.addEventListener('click', (e) => {
  const btn = e.target.closest('#topicsPagination .page-btn');
  if (!btn) return;
  if (btn.hasAttribute('disabled')) return;

  const nav = btn.dataset.topicNav;
  const page = btn.dataset.topicPage;

  const totalPages = Math.max(1, Math.ceil((filteredTopics?.length ?? 0) / TOPICS_PAGE_SIZE));

  if (nav === 'prev') topicsCurrentPage = Math.max(1, topicsCurrentPage - 1);
  else if (nav === 'next') topicsCurrentPage = Math.min(totalPages, topicsCurrentPage + 1);
  else if (page) topicsCurrentPage = parseInt(page, 10) || 1;

  renderTopics();
});


window.addEventListener('resize', applyResponsiveSidebar);
applyResponsiveSidebar();

// ✅ 마우스가 왼쪽 가장자리로 오면 열기, 떠나면 닫기
document.addEventListener('mousemove', (e) => {
  if (!document.body.classList.contains('sidebar-collapsed')) return;
  if (sidebarPinnedOpen) return;

  if (e.clientX <= EDGE_HOTZONE) {
    if (!sidebarTempOpen) openSidebarTemp();
  }
});

document.addEventListener('click', (e) => {
  const btn = e.target.closest('[data-user-action]');
  if (!btn) return;

  const action = btn.dataset.userAction;
  const userId = btn.dataset.userId; // 항상 문자열

  if (!userId) return;

  if (action === 'history') viewUserActivity(userId);
  else if (action === 'edit') editUser(userId);
  else if (action === 'delete') confirmDeleteUser(userId);
});

// 사이드바에서 마우스 빠져나가면 다시 닫기
document.getElementById('sidebar').addEventListener('mouseleave', () => {
  if (document.body.classList.contains('sidebar-collapsed')) {
    closeSidebarTemp();
  }
});

// hitbox에 올라오면 열기 (mousemove보다 안정적)
document.getElementById('sidebarHitbox').addEventListener('mouseenter', () => {
  if (document.body.classList.contains('sidebar-collapsed')) openSidebarTemp();
});

document.addEventListener('click', async (e) => {
  const btn = e.target.closest('#articlesPagination button');
  if (!btn) return;

  if (btn.hasAttribute('disabled')) return;

  const nav = btn.dataset.articleNav;
  const page = btn.dataset.articlePage;

  // 현재 필터 기준으로 최신화
  refilterArticlesKeepPage();

  let targetPage = articlesCurrentPage;
  if (nav === 'prev') targetPage = Math.max(1, articlesCurrentPage - 1);
  else if (nav === 'next') targetPage = articlesCurrentPage + 1;      // ✅ +1 허용
  else if (page) targetPage = parseInt(page, 10) || 1;

  const requiredCount = targetPage * ARTICLE_PAGE_SIZE;

  // ✅ 이미 로드/필터된 데이터로 충분하면 바로 렌더
  if (requiredCount <= filteredArticles.length) {
    articlesCurrentPage = targetPage;
    renderArticles();
    return;
  }

  // ✅ 더 가져올 수 없으면 마지막 페이지로 보정
  if (!articlesHasMore) {
    articlesCurrentPage = Math.max(1, Math.ceil(filteredArticles.length / ARTICLE_PAGE_SIZE));
    renderArticles();
    return;
  }

  showToast('추가 기사를 불러오는 중...', 'info');

  // ✅ 필요한 만큼 확보될 때까지 반복 fetch
  while (articlesHasMore && requiredCount > filteredArticles.length) {
    const added = await fetchMoreArticles();     // existing function
    refilterArticlesKeepPage();
    if (!added) break;
  }

  // ✅ 가능한 범위 내로 보정 후 렌더
  const lastPage = Math.max(1, Math.ceil(filteredArticles.length / ARTICLE_PAGE_SIZE));
  articlesCurrentPage = Math.min(targetPage, lastPage);
  renderArticles();
});

document.addEventListener('click', (e) => {
  const btn = e.target.closest('[data-article-action]');
  if (!btn) return;

  const action = btn.dataset.articleAction;
  const articleId = btn.dataset.articleId;

  if (action === 'toggle') {
    confirmToggleArticleStatus(articleId, btn.dataset.articleNext);
  }
});

document.addEventListener('click', (e) => {
  const btn = e.target.closest('[data-topic-action]');
  if (!btn) return;

  const action = btn.dataset.topicAction;
  const topicId = btn.dataset.topicId;

  if (!topicId) return;

  if (action === 'edit') editTopic(topicId);
  if (action === 'delete') confirmDeleteTopic(topicId);
});

document.addEventListener('input', (e) => {
  if (e.target && e.target.id === 'topicSearchInput') filterTopics();
});

function isJobEnabledFromNextRun(nextRunTime) {
  // APScheduler에서 pause_job되면 next_run_time이 null이 되는 케이스가 많음
  return Boolean(nextRunTime);
}

function loadSchedulerToggles() {
  return $.ajax({
    url: "/api/admin/scheduler/jobs",
    method: "GET",
    dataType: "json"
  }).then(res => {
    const jobs = res.jobs || [];
    const map = {};
    jobs.forEach(j => { map[j.id] = j; });

    // 3개 토글 세팅
    ["news_full_pipeline", "session_timeout_job", "polarity_daily_0500"].forEach(jobId => {
      const el = document.querySelector(`input[data-job-id="${jobId}"]`);
      if (!el) return;

      const job = map[jobId];
      const enabled = job ? isJobEnabledFromNextRun(job.next_run_time) : false;
      el.checked = enabled;
      el.disabled = false;
    });
  }).catch(err => {
    console.error("loadSchedulerToggles failed:", err);
    showToast("스케줄러 상태를 불러오지 못했습니다.", "error");

    // 실패 시 토글 잠그기(잘못된 조작 방지)
    ["news_full_pipeline", "session_timeout_job", "polarity_daily_0500"].forEach(jobId => {
      const el = document.querySelector(`input[data-job-id="${jobId}"]`);
      if (el) el.disabled = true;
    });
  });
}

function patchSchedulerJob(jobId, enabled) {
  // enabled=true => paused=false
  // enabled=false => paused=true
  return $.ajax({
    url: `/api/admin/scheduler/jobs/${encodeURIComponent(jobId)}`,
    method: "PATCH",
    contentType: "application/json",
    dataType: "json",
    data: JSON.stringify({ paused: !enabled })
  });
}
function onSchedulerToggle(checkboxEl) {
  const jobId = checkboxEl.dataset.jobId;
  if (!jobId) return;

  const nextEnabled = checkboxEl.checked;
  const prevEnabled = !nextEnabled;

  // 중복 클릭 방지
  checkboxEl.disabled = true;

  patchSchedulerJob(jobId, nextEnabled).then(() => {
    showToast(`${jobId} ${nextEnabled ? "활성화" : "비활성화"} 완료`, "success");
  }).catch(err => {
    console.error("patchSchedulerJob failed:", err);

    // 롤백
    checkboxEl.checked = prevEnabled;
    showToast(`${jobId} 설정 변경 실패`, "error");
  }).always(() => {
    checkboxEl.disabled = false;
  });
}

</script>
</body>
</html>
